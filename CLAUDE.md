# Loder

Минималистичное macOS приложение для меню-бара, которое мониторит активность Claude в реальном времени.

## Технологии

- **Язык**: Swift 5.0
- **Фреймворк**: SwiftUI + AppKit
- **Платформа**: macOS 13.0+
- **Bundle ID**: `com.loder.app`

## Структура проекта

```
Loder/
├── LoderApp.swift              # Точка входа, AppDelegate, UI меню-бара
├── ClaudeActivityMonitor.swift # Логика мониторинга активности
└── Info.plist                  # Конфигурация приложения
```

## Как работает

Приложение отображает индикатор в меню-баре:
- **A** — Claude активен (идёт обмен данными с API)
- **I** — Claude неактивен

### Метод детекции: Мониторинг сетевого трафика

Используется системная утилита `nettop` для отслеживания реального трафика данных:

```bash
nettop -P -L 1 -x | grep -Ei 'claude' | awk -F',' '{sum += $5 + $6} END {print sum+0}'
```

**Почему именно так:**

1. **Не CPU** — загрузка процессора варьируется в зависимости от мощности машины, ненадёжный индикатор
2. **Не открытые соединения** — Claude держит persistent connections даже когда не активен
3. **Дельта трафика** — сравниваем накопительные байты между проверками

**Параметры nettop:**
- `-P` — показывать только суммарный трафик процесса (без деталей соединений)
- `-L 1` — один сэмпл (мгновенный, без задержки)
- `-x` — вывод в CSV формате с числами

**Что мониторим:**
- Любые процессы содержащие "claude" в имени (Claude Helper, claude CLI и т.д.)
- Суммируем `bytes_in` (колонка 5) + `bytes_out` (колонка 6)
- Сравниваем с предыдущим значением — если разница > 50 байт, считаем активным

### Алгоритм

- **Интервал проверки**: 0.3 сек
- **Гистерезис**: 3 последовательных неактивных проверки для смены на "I" (защита от мерцания)
- **Порог активности**: > 50 байт трафика между проверками

## Известные особенности

- Claude Code запущенный через Claude.app использует `Claude Helper` для сетевых запросов
- Claude CLI запущенный напрямую из терминала создаёт собственные соединения
- Оба варианта корректно детектируются через grep по "claude"

## Сборка

```bash
xcodebuild -scheme Loder -configuration Debug build
```

Или открыть `Loder.xcodeproj` в Xcode и собрать (Cmd+B).

## Зависимости

Нет внешних зависимостей. Использует только:
- Foundation framework
- SwiftUI + AppKit
- Системную утилиту `/usr/bin/nettop`
